<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>FIREWORKS</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
body{margin:0;overflow:hidden;background:black;font-family:'Press Start 2P', cursive;}
#controls{position:fixed;bottom:10px;left:10px;display:flex;gap:4px;transition:opacity 0.5s;}
.button{width:40px;height:20px;background:#333;color:white;font-size:12px;text-align:center;line-height:20px;font-family:'Press Start 2P', cursive;user-select:none;cursor:pointer;}
#startScreen{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;flex-direction:column;color:white;font-size:20px;}
#title{font-size:28px;margin-bottom:20px;color:#ffcc33;text-shadow:0 0 5px #ff0,0 0 10px #ff6600;}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="startScreen">
  <div id="title">FIREWORKS</div>
  <div>Press SPACE to Start</div>
</div>
<div id="controls">
  <div class="button" id="toggleBgm">BGM</div>
  <div class="button" id="toggleSe">SE</div>
  <div class="button" id="finaleButton">F</div>
</div>
<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;
window.addEventListener("resize",()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;initStars();initLanterns(canvas.height-100);initPeople();});

// ===== ゲーム状態 =====
let gameStarted=false;

// ===== 音管理 =====
const bgm=new Audio("bgm.mp3");bgm.loop=true;bgm.volume=0.7;
const seLaunch1=new Audio("se_launch1.mp3");
const seLaunch2=new Audio("se_launch2.mp3");
const seLaunch3=new Audio("se_launch3.mp3");
const seExplode1=new Audio("se_explode1.mp3");
const seExplode2=new Audio("se_explode2.mp3");
const seExplode3=new Audio("se_explode3.mp3");
let bgmOn=true,seOn=true;

const launchSounds = [seLaunch1, seLaunch2, seLaunch3];
const explodeSounds = [seExplode1, seExplode2, seExplode3];
let currentLaunchSound = 0;
let currentExplodeSound = 0;

function playLaunchSe(){
  if(!seOn) return;
  const sound = launchSounds[currentLaunchSound];
  sound.currentTime = 0;
  sound.volume = 0.3;
  sound.play();
  currentLaunchSound = (currentLaunchSound + 1) % launchSounds.length;
}
function playExplodeSe(){
  if(!seOn) return;
  const sound = explodeSounds[currentExplodeSound];
  sound.currentTime = 0;
  sound.volume = 0.3;
  sound.play();
  currentExplodeSound = (currentExplodeSound + 1) % explodeSounds.length;
}

// ===== 星と流れ星 =====
let stars=[],shootingStars=[];
class ShootingStar {
  constructor() {
    this.x=(100 + Math.random() * (canvas.width - 200));
    this.y=Math.random()*canvas.height*0.5;
    this.length=30+Math.random()*20;
    this.speed=6+Math.random()*3;
    this.life=50;
  }
  update(){this.x+=this.speed;this.y+=this.speed*0.2;this.life--;}
  draw(ctx){ctx.fillStyle="white";for(let i=0;i<this.length;i++){ctx.fillRect(Math.round(this.x-i),Math.round(this.y-i*0.2),1,1);}}
}
function initStars(){stars=[];for(let i=0;i<200;i++)stars.push({x:(100 + Math.random() * (canvas.width - 200)),y:Math.random()*canvas.height*0.7,size:2,alpha:Math.random(),phase:Math.random()*Math.PI*2});}

// ===== カラーパレット =====
const colorPalettes=[["#ff4b5c","#ffb400","#1e90ff","#6a5acd","#32cd32"],["#ff6f61","#ffcc00","#00bcd4","#8e44ad","#e67e22"]];

// ===== 煙 =====
class Smoke{constructor(x,y,size,upward=false){this.x=x;this.y=y;this.size=size;this.life=100;this.alpha=0.3;this.upward=upward;this.vx=(Math.random()-0.5)*0.5;this.vy=upward?-0.3-Math.random()*0.5:(Math.random()-0.5)*0.2;this.offset=Math.random()*Math.PI*2;}
update(){this.x+=this.vx+Math.sin(Date.now()/300+this.offset)*0.2;this.y+=this.vy+Math.cos(Date.now()/400+this.offset)*0.2;this.alpha-=0.003;this.life--;}
draw(ctx){ctx.fillStyle=`rgba(200,200,200,${this.alpha})`;ctx.fillRect(Math.round(this.x),Math.round(this.y),Math.ceil(this.size),Math.ceil(this.size));}}

// ===== パーティクル =====
class Particle{constructor(x,y,color,angle,speed){this.x=x;this.y=y;this.color=color;this.angle=angle;this.speed=speed;this.life=100;}
update(){this.x+=Math.cos(this.angle)*this.speed;this.y+=Math.sin(this.angle)*this.speed;this.speed*=0.95;this.life--;}
draw(ctx){ctx.fillStyle=this.color;ctx.fillRect(Math.round(this.x),Math.round(this.y),2,2);}}

// ===== 花火 =====
class Firework{
  constructor(x, y, isChild = false, parentSize = 1, initialColors = null) {
    this.x = x;
    this.y = y;
    this.isChild = isChild;
    this.exploded = false;
    this.particles = [];
    this.smokes = [];
    this.colors = [];

    if (isChild) {
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 3 + 1;
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed - 2; // 少し上に持ち上げる
        this.life = 40 + Math.random() * 20; // 子花火が爆発するまでの時間
        this.size = parentSize * (0.3 + Math.random() * 0.2);
        this.isMultiBreak = false; // 子花火はさらに分裂しない
        this.colors = initialColors;
        this.shapeType = ["circle", "ring"][Math.floor(Math.random() * 2)];
    } else {
        this.vx = (Math.random() - 0.5) * 2;
        this.vy = -5 - Math.random() * 3;
        this.size = 0.8 + Math.random() * 2.2;
        this.isMultiBreak = Math.random() < 0.25; // 25%の確率で子持ち花火に
        let palette = colorPalettes[Math.floor(Math.random() * colorPalettes.length)];
        let colorNum = Math.min(4, Math.ceil(this.size * 1.5) + 1);
        while (this.colors.length < colorNum) this.colors.push(palette[Math.floor(Math.random() * palette.length)]);
        this.shapeType = ["circle", "ring", "heart", "star", "spiral", "peony"][Math.floor(Math.random() * 6)];
        playLaunchSe();
    }
  }

  update(){
    if (!this.exploded) {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.04; // 重力
        if (this.isChild) {
            this.life--;
            if (this.life <= 0) this.explode();
        } else {
            this.smokes.push(new Smoke(this.x, this.y + 10, 3, true));
            if (this.vy >= -1) this.explode(); // 頂点近くで爆発
        }
    } else {
        this.particles.forEach(p => p.update());
        this.particles = this.particles.filter(p => p.life > 0);
        this.smokes.forEach(s => s.update());
        this.smokes = this.smokes.filter(s => s.life > 0);
    }
  }

  explode(){
    this.exploded = true;
    playExplodeSe();
    shakeIntensity = this.size * 0.8;

    if (this.isMultiBreak) {
        const childCount = 5 + Math.floor(this.size * 3);
        for (let i = 0; i < childCount; i++) {
            fireworks.push(new Firework(this.x, this.y, true, this.size, this.colors));
        }
    } else {
        const num = Math.floor(50 * this.size + 30);
        for (let i = 0; i < num; i++) {
            const angle = (Math.PI * 2 * i) / num;
            let speed = (1.5 + Math.random() * 2) * this.size;
            const color = this.colors[Math.floor(Math.random() * this.colors.length)];
            let xOffset = 0, yOffset = 0;
            let s = this.size * 0.8;

            if (this.shapeType == "peony") { speed *= 0.85; }
            if (this.shapeType == "spiral") { const spiralOffset = i * 0.2; xOffset = Math.cos(angle) * spiralOffset; yOffset = Math.sin(angle) * spiralOffset; }
            if (this.shapeType == "ring") { xOffset = Math.cos(angle) * 12 * s; yOffset = Math.sin(angle) * 12 * s; }
            if (this.shapeType == "heart") { s = this.size * 0.7; xOffset = s * 16 * Math.pow(Math.sin(angle), 3); yOffset = s * (-13 * Math.cos(angle) + 5 * Math.cos(2 * angle) + 2 * Math.cos(3 * angle)); }
            if (this.shapeType == "star") { s = this.size * 0.7; xOffset = s * Math.cos(angle) * ((i % 2 ? 15 : 7)); yOffset = s * Math.sin(angle) * ((i % 2 ? 15 : 7)); }

            this.particles.push(new Particle(this.x + xOffset, this.y + yOffset, color, angle, speed));
        }
    }
  }

  draw(ctx){
    this.smokes.forEach(s => s.draw(ctx));
    if (!this.exploded) {
        ctx.fillStyle = 'white';
        ctx.fillRect(Math.round(this.x), Math.round(this.y), 2, 2);
    }
    this.particles.forEach(p => p.draw(ctx));
  }
}

let fireworks=[];

// ===== カメラ揺れ =====
let shakeX=0,shakeY=0,shakeIntensity=0;
function updateCamera(){shakeIntensity*=0.92;shakeX=(Math.random()-0.5)*shakeIntensity;shakeY=(Math.random()-0.5)*shakeIntensity;}

// ===== 提灯 =====
let lanterns=[];
function initLanterns(groundY){lanterns=[];for(let i=0;i<10;i++)lanterns.push({x:80+i*120,y:groundY-80,baseSize:10,pulse:Math.random()*Math.PI*2});}

// ===== 人 =====
let people=[];
function initPeople(){people=[];const groundY=canvas.height-100;for(let i=0;i<8;i++){const size=0.5+Math.random()*0.5;const speed=0.2+Math.random()*0.3;const x=i*100;people.push({x:x,y:groundY,size:size,speed:speed});}}

// ===== 前景 =====
function drawForeground(ctx){
  const groundY=canvas.height-100;
  ctx.fillStyle="#111";ctx.fillRect(0,groundY,canvas.width,100);
  ctx.fillStyle="#222";
  for(let i=0;i<5;i++){let x=i*(canvas.width/5)+50;ctx.fillRect(x,groundY-60,100,60);}
  lanterns.forEach(l=>{const flick=Math.sin(Date.now()/300+l.pulse)*2;ctx.save();ctx.shadowBlur=12;ctx.shadowColor="red";ctx.fillStyle="red";ctx.fillRect(Math.round(l.x-flick/2),Math.round(l.y-flick/2),Math.ceil(l.baseSize+flick),Math.ceil(l.baseSize+flick));ctx.restore();});
  people.forEach(p=>{p.x+=p.speed;if(p.x>canvas.width)p.x=-20;ctx.fillStyle="#111";ctx.fillRect(Math.round(p.x),groundY-32*p.size,Math.ceil(12*p.size),Math.ceil(12*p.size));ctx.fillRect(Math.round(p.x-4*p.size),groundY-20*p.size,Math.ceil(20*p.size),Math.ceil(40*p.size));ctx.fillRect(Math.round(p.x-10*p.size),groundY,Math.ceil(50*p.size),Math.ceil(8*p.size));});
}

// ===== 背景 =====
function drawBackground(ctx){
  // ゆらぐグラデーション
  const time=Date.now()/5000;
  const grad=ctx.createLinearGradient(0,0,0,canvas.height);
  grad.addColorStop(0,"rgb(0,"+(16+Math.sin(time)*16)+","+(64+Math.sin(time)*32)+")");
  grad.addColorStop(1,"black");
  ctx.fillStyle=grad;ctx.fillRect(0,0,canvas.width,canvas.height);
  stars.forEach(s=>{const flick=Math.sin(Date.now()/500+s.phase)*0.8;ctx.fillStyle=`rgba(255,255,255,${s.alpha})`;ctx.fillRect(Math.round(s.x),Math.round(s.y),Math.ceil(2+flick),Math.ceil(2+flick));});
  if(Math.random()<0.003)shootingStars.push(new ShootingStar());
  shootingStars.forEach(ss=>{ss.update();ss.draw(ctx);});
  shootingStars=shootingStars.filter(ss=>ss.life>0);
}

// ===== メインループ =====
function animate(){
  if(!gameStarted)return;
  updateCamera();
  ctx.save();ctx.translate(shakeX,shakeY);
  drawBackground(ctx);
  fireworks.forEach(f=>{f.update();f.draw(ctx);});
  fireworks=fireworks.filter(f=>!f.exploded||f.particles.length>0||f.smokes.length>0);
  drawForeground(ctx);
  ctx.restore();
  requestAnimationFrame(animate);
}

// ===== UIボタン =====
document.getElementById("toggleBgm").addEventListener("click",()=>{bgmOn=!bgmOn;updateBgmButton();if(bgmOn)bgm.play();else bgm.pause();});
document.getElementById("toggleSe").addEventListener("click",()=>{seOn=!seOn;updateSeButton();});
const finaleButton = document.getElementById("finaleButton");
finaleButton.addEventListener("click", startFinale);
finaleButton.addEventListener("touchstart", startFinale);

function updateBgmButton(){ document.getElementById("toggleBgm").textContent="BGM: "+(bgmOn?"ON":"OFF"); }
function updateSeButton(){ document.getElementById("toggleSe").textContent="SE: "+(seOn?"ON":"OFF"); }
updateBgmButton();
updateSeButton();

// ===== 自動花火 =====
function autoFire(){if(!gameStarted || finaleActive)return;fireworks.push(new Firework((100 + Math.random() * (canvas.width - 200)),canvas.height));}
setInterval(autoFire,2000);

// ===== フィナーレ機能 =====
let finaleActive = false;
function startFinale() {
    if (finaleActive) return;
    finaleActive = true;
    const finaleInterval = setInterval(() => {
        fireworks.push(new Firework(Math.random() * canvas.width, canvas.height));
    }, 250);

    setTimeout(() => {
        clearInterval(finaleInterval);
        finaleActive = false;
    }, 15000); // 15秒間のフィナーレ
}

// ===== キー入力 =====
window.addEventListener("keydown",(e)=>{
  if(!gameStarted && e.code==="Space"){startGame();return;}
  if(gameStarted && e.key>='1'&&e.key<='9'){const pos=(canvas.width/10)*parseInt(e.key);fireworks.push(new Firework(pos,canvas.height));}
  if(gameStarted && e.key.toLowerCase()==='f'){startFinale();}
});

// ===== UI非表示制御 =====
let uiTimeout;
function showControls(){document.getElementById("controls").style.opacity="1"; clearTimeout(uiTimeout); uiTimeout=setTimeout(()=>{document.getElementById("controls").style.opacity="0";},3000);}
window.addEventListener("mousemove",showControls);window.addEventListener("keydown",showControls);
showControls();

// ===== カーソル非表示制御 =====
let cursorTimeout;
function handleCursorActivity() {
  document.body.style.cursor = 'auto';
  clearTimeout(cursorTimeout);
  cursorTimeout = setTimeout(() => { document.body.style.cursor = 'none'; }, 2000);
}
window.addEventListener('mousemove', handleCursorActivity);
handleCursorActivity();

// ゲーム開始
function startGame(){
  gameStarted = true;
  document.getElementById("startScreen").style.display = "none";
  initStars(); initLanterns(canvas.height-100); initPeople();
  bgm.play(); seOn = true;
  animate();
}

// START画面クリック・タップでゲーム開始
document.getElementById("startScreen").addEventListener("click", startGame);
document.getElementById("startScreen").addEventListener("touchstart", startGame);

// ゲーム中タップでランダム位置花火
canvas.addEventListener("click", () => {
  if(gameStarted) fireworks.push(new Firework((100 + Math.random() * (canvas.width - 200)), canvas.height));
});
canvas.addEventListener("touchstart", () => {
  if(gameStarted) fireworks.push(new Firework((100 + Math.random() * (canvas.width - 200)), canvas.height));
});

// 最初のクリックで音声再生を許可
document.body.addEventListener("click",()=>{if(!gameStarted){bgm.play();}}, {once:true});
</script>
</body>
</html>
